<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Service Mesh Communication Flows :: Red Hat Service Mesh - Envoy &amp; Istio Control Plane</title>
    <link rel="canonical" href="http://localhost:3000/rhs-build-course/index.html/rh-servicemesh-envoy-crtplane/03-flows.html">
    <link rel="prev" href="02-jumpapp.html">
    <link rel="next" href="04-relationship.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../_/css/site.css">
<link rel="icon" href="../_/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://developers.redhat.com" target="_blank"><img
          src="../_/img/header_logo.png" height="40px" alt="Red Hat Developer Program"></a>
      <a class="navbar-item" href="http://localhost:3000/rhs-build-course/index.html">Red Hat Service Mesh - Envoy &amp; Istio Control Plane</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Books</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">CheatSheets</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">CheatSheet A</a>
            <a class="navbar-item" href="#">CheatSheet B</a>
            <a class="navbar-item" href="#">CheatSheet C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Upcoming Events</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Event A</a>
            <a class="navbar-item" href="#">Event B</a>
            <a class="navbar-item" href="#">Event C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">More Tutorials</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Tutorial A</a>
            <a class="navbar-item" href="#">Tutorial B</a>
            <a class="navbar-item" href="#">Tutorial C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="rh-servicemesh-envoy-crtplane" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Red Hat Service Mesh - Envoy &amp; Istio Control Plane</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="01-setup.html">1. Setup</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#prerequisites">1.1 Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="01-setup.html#laboratory">1.2 Laboratory</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="02-jumpapp.html">2. Jump App Deployment</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#login">2.1 Login in Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#github">2.2 Clone GitHub Repository</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#jumpappobjects">2.3 Create Jump App Objects in Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#test">2.4 Confirm Jump App is already running in Openshift</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="02-jumpapp.html#testapp">2.5 Access to Jump App</a>
  </li>
</ul>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="03-flows.html">3. Service Mesh Communication Flows</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#gw">3.1 Gateways</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#vsvc">3.2 Virtual Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#dr">3.3 Destination Rules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#services">3.4 K8s Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#annotation">3.5 Add Istio Sidecar annotation in Jump App deployments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#routes">3.6 Configure Routes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="#test">3.7 Confirm Jump App is running again</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="04-relationship.html">4. Istio-Envoy Objects Relationship</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-relationship.html#dr">4.1 Destination Rules</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-relationship.html#vsvc">4.2 Virtual Services</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="04-relationship.html#se">4.3 Service Entry</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="05-envoy.html">5. Envoy Proxy</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="05-envoy.html#ef">5.1 Envoy Filters</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="06-crtlplane.html">6. Istio Control Plane</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="07-services.html">7. Istio Global Services</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Red Hat Service Mesh - Envoy &amp; Istio Control Plane</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <span class="title">Red Hat Service Mesh - Envoy & Istio Control Plane</span>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Red Hat Service Mesh - Envoy & Istio Control Plane</a></li>
    <li><a href="03-flows.html">3. Service Mesh Communication Flows</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/acidonper/rh-service-mesh-v2-istio-crtlplane/edit/master/documentation/modules/ROOT/pages/03-flows.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<article class="doc">
<h1 class="page">Service Mesh Communication Flows</h1>
<div id="preamble">
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Let your Instructor know that you are at this point
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>XXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXX
XXXXXXXXXXXXXXXXXXXXXXXX</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_red_hat_service_mesh_objects"><a class="anchor" href="#_create_red_hat_service_mesh_objects"></a>Create Red Hat Service Mesh objects</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In order to make an application available through Service Mesh, it is required to create a set of Service Mesh objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Gateways - Describes a load balancer operating at the edge of the mesh receiving incoming or outgoing HTTP/TCP connections.</p>
</li>
<li>
<p>Virtual Services - Defines a set of traffic routing rules to apply when a host is addressed.</p>
</li>
<li>
<p>Destination Rules - Defines policies that apply to traffic intended for a service after routing has occurred.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this step, you have to be able to deploy this <em>Jump App</em> Service Mesh objects in order to introduce this application in the Service Mesh and publish it to external clients.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Please, replace <strong>&lt;user_namespace&gt;</strong> with the value provided by the Instructor at the beginning of this tutorial.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="gw"><a class="anchor" href="#gw"></a>Gateways</h3>
<div class="paragraph">
<p>First at all, it is required to create a Gateway for external access. In the <em>Jump App</em> architecture, you have a couple of services which have to be exposes to external clients in order to present the Frontend and Backend services.</p>
</div>
<div class="paragraph">
<p>Please, return to git repository and create <strong>gateways</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/00-jump-app-gws.yaml --param-file=params.env --ignore-unknown-parameters | oc create -f -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">gateway.networking.istio.io/back-golang created
gateway.networking.istio.io/front-javascript created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="vsvc"><a class="anchor" href="#vsvc"></a>Virtual Services</h3>
<div class="paragraph">
<p>Once gateways are created and the application is reacheabled, it is time to create the traffic rules inside your namespace in order to route this traffic to the specific endpoint.</p>
</div>
<div class="paragraph">
<p>Please, create <strong>virtual services</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/01-jump-app-vss.yaml --param-file=params.env --ignore-unknown-parameters | oc create -f -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">virtualservice.networking.istio.io/back-golang created
virtualservice.networking.istio.io/back-python created
virtualservice.networking.istio.io/back-springboot created
virtualservice.networking.istio.io/front-javascript created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="dr"><a class="anchor" href="#dr"></a>Destination Rules</h3>
<div class="paragraph">
<p>Once previous objects are created, it is required  to define the policies which will be applied to traffic intended for a service after routing has occurred.</p>
</div>
<div class="paragraph">
<p>Please, create <strong>destination rules</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/02-jump-app-drs.yaml --param-file=params.env --ignore-unknown-parameters | oc create -f -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">destinationrule.networking.istio.io/back-golang created
destinationrule.networking.istio.io/back-python created
destinationrule.networking.istio.io/back-springboot created
destinationrule.networking.istio.io/front-javascript created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="services"><a class="anchor" href="#services"></a>K8s Services</h3>
<div class="paragraph">
<p>Once you have created gateways, virtual services and destination rules, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.</p>
</div>
<div class="paragraph">
<p>Please, create <strong>k8s services</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/03-jump-app-services.yaml --param-file=params.env --ignore-unknown-parameters | oc create -f -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">service/back-golang created
service/back-python created
service/back-springboot created
service/front-javascript created</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="annotation"><a class="anchor" href="#annotation"></a>Add <em>Istio Sidecar</em> annotation in <em>Jump App</em> deployments</h3>
<div class="paragraph">
<p>Finally, it is time to include a specific annotation in your app deployments in order to allow Service Mesh control and run the respective envoy sidecar automatically.</p>
</div>
<div class="paragraph">
<p>Please, edit each <em>Jump App Microservice</em> deployment executing the commands added below:</p>
</div>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc patch deployment front-javascript-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;
oc patch deployment back-springboot-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;
oc patch deployment back-python-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;
oc patch deployment back-golang-v1 -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;
oc patch deployment mongo -p '{"spec":{"template":{"metadata":{"annotations":{"sidecar.istio.io/inject":"true"}}}}}' -n &lt;user_namespace&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="routes"><a class="anchor" href="#routes"></a>Configure Routes</h3>
<div class="paragraph">
<p>An OpenShift Container Platform <strong>route</strong> exposes a service at a host name, such as www.example.com, so that external clients can reach it by name. When you manage routes outside Service Mesh, it is required to create these objects in each namespace.</p>
</div>
<div class="paragraph">
<p>Once you have a project integrated in Service Mesh, routes should be created in istio-system, or wherever the control plane is installed, to make this external service available through the Istio Ingress Gateway. For this reason, it is required to follow next steps:</p>
</div>
<div class="sect3">
<h4 id="_delete_all_current_routes_in_user_namespace"><a class="anchor" href="#_delete_all_current_routes_in_user_namespace"></a><strong>Delete all current routes in &lt;user_namespace&gt;</strong></h4>
<div class="listingblock console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n &lt;user_namespace&gt; | grep -v NAME | awk '{print "oc delete route " $1}' | sh</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">route.route.openshift.io/back-golang-v1 deleted
route.route.openshift.io/back-golang deleted
route.route.openshift.io/back-javascript-v1 deleted
route.route.openshift.io/back-javascript deleted</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_create_a_new_routes_in_istio_system"><a class="anchor" href="#_create_a_new_routes_in_istio_system"></a><strong>Create a new routes in istio-system</strong></h4>
<div class="paragraph">
<p>Once "regular" routes are deleted, it is required to create the new ones.</p>
</div>
<div class="paragraph">
<p>Please, create <strong>routes</strong> through the respective Openshift template executing the following command:</p>
</div>
<div class="listingblock lines_space console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">oc process -f 03-jump-app-flows/04-jump-app-routes.yaml --param-file=params.env --ignore-unknown-parameters | oc create -f -</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">route.route.openshift.io/back-golang-&lt;user_namespace&gt; created
route.route.openshift.io/back-golang-v1-&lt;user_namespace&gt; created
route.route.openshift.io/front-javascript-&lt;user_namespace&gt; created
route.route.openshift.io/front-javascript-v1-&lt;user_namespace&gt; created</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="test"><a class="anchor" href="#test"></a>Confirm <em>Jump App</em> is running again</h3>
<div class="paragraph">
<p>Once <em>Jump App</em> objects have been created in Openshift, it is required to follow next steps in order to ensure your demo app is running properly:</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Look at the number of containers in each microservice, it must contains 2 container per each pod (<strong>READY 2/2</strong>).
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Get pods</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get pods</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">NAME                                   READY   STATUS    RESTARTS   AGE
back-golang-v1-7fb9ff7bdc-mwp8b        2/2     Running   0          1m
back-python-v1-74c65d94b5-9hzxd        2/2     Running   0          1m
back-springboot-v1-74db6bb8b4-pw74s    2/2     Running   0          1m
front-javascript-v1-7b6d4fb65c-9fdfb   2/2     Running   0          1m
mongo-7c8f67cc4b-t9dnf                 2/2     Running   0          1m</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Obtain external services URLs</p>
</li>
</ul>
</div>
<div class="listingblock lines_7 console-input">
<div class="content">
<pre class="highlightjs highlight"><code class="language-input hljs" data-lang="input">oc get routes -n istio-system | grep &lt;user_namespace&gt;</code></pre>
</div>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">back-golang-&lt;user_namespace&gt;        back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;         istio-ingressgateway   http2   edge/Redirect        None
back-golang-v1-&lt;user_namespace&gt;        back-golang-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;         istio-ingressgateway   http2   edge/Redirect        None
front-javascript-&lt;user_namespace&gt;   front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;    istio-ingressgateway   http2   edge/Redirect        None
front-javascript-v1-&lt;user_namespace&gt;   front-javascript-&lt;user_namespace&gt;.&lt;openshift_apps_domain&gt;    istio-ingressgateway   http2   edge/Redirect        None</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Visit the <strong>back</strong>, <em>back-golang-&lt;user_namespace&gt;</em> and  <em>back-golang-v1-&lt;user_namespace&gt;</em>, routes via your web browser</p>
</li>
<li>
<p>Visit the <strong>front</strong>, <em>front-javascript-golang-&lt;user_namespace&gt;</em>, route via your web browser. In addition, configure <strong>[ 1 ]</strong> retries with <strong>[ 1 ]</strong> interval and press <strong>[ JUMP ]</strong> and ensure the following message is displaying in your screen</p>
</li>
</ul>
</div>
<div class="listingblock console-output">
<div class="content">
<pre class="highlightjs highlight"><code class="language-output hljs" data-lang="output">Jump 0 -&gt; &lt;tutorial_date&gt; GMT+0100 (Central European Standard Time) {"code":200,"message":"/jump - Greetings from Python!"}</code></pre>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It is required to accept <strong>self-signed certificates</strong> provided by Openshift
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Alternatively, you are able to review the Service Mesh traffic flow by Kiali console visiting <strong>&lt;kiali_url&gt;</strong> (<em>E.g. <a href="https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com" class="bare">https://kiali-istio-system.apps.tutorialrhmesh.sandbox507.opentlc.com</a></em>)
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="02-jumpapp.html">2. Jump App Deployment</a></span>
  <span class="next"><a href="04-relationship.html">4. Istio-Envoy Objects Relationship</a></span>
</nav>
</article>
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
  </div>
</main>
</div>
<footer class="footer">
  <a class="rhd-logo" href="https://developers.redhat.com" target="_blank"></div>
</footer>
<script src="../_/js/vendor/clipboard.js"></script>
<script src="../_/js/site.js"></script>
<script async src="../_/js/vendor/highlight.js"></script>
  </body>
</html>
